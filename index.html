<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Протокол работы мультидисциплинарной бригады</title>
    
    <!-- Подключение необходимых библиотек -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.3/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid black; padding: 5px; text-align: left; }
        h1 { text-align: center; }
    </style>
</head>
<body>
    <h1>Протокол работы мультидисциплинарной бригады отделения реабилитации для детей РДКБ</h1>
    
    <p><strong>Пациент ФИО:</strong> <span id="fio"></span></p>
    <p><strong>Возраст:</strong> <span id="vozrast"></span></p>
    <p><strong>Диагноз:</strong> <span id="diagnoz"></span></p>
    <p><strong>Дата заседания:</strong> <span id="data_zasedaniya"></span></p>
    <p><strong>Реабилитационный диагноз:</strong> <span id="reabilitacionnyi_diagnoz"></span></p>

    <table id="doctorsTable">
        <thead>
            <tr>
                <th>Состав МКБ</th>
                <th>Участие в МКБ</th>
                <th>Цель</th>
                <th>Домен и оценка по МКФ</th>
                <th>Задачи</th>
                <th>Методика</th>
                <th>Исполнитель (ФИО)</th>
                <th>Оценка по МКФ до курса</th>
                <th>Оценка по МКФ после курса</th>
            </tr>
        </thead>
        <tbody>
            <!-- Строки будут добавлены сюда -->
        </tbody>
    </table>

    <p><strong>Врач ФРМ (ФИО):</strong> <span id="vrach_frm"></span> <span style="float: right;">Подпись _______________</span></p>

    <script>
    // Указываем, какие колонки нужны для работы виджета
    grist.ready({
      requiredAccess: 'read table',
      columns: [
        'fio', 'vozrast', 'diagnoz', 'data_zasedaniya', 'reabilitacionnyi_diagnoz', 'vrach_frm',
        'fio_sotr', 'uchastie_v_mkb', 'cel', 'domen_i_ocenka_po_mkf', 'zadachi', 'metodika',
        'ocenka_po_mkf_do_kursa', 'ocenka_po_mkf_posle_kursa'
      ]
    });

    // Обработка выбранной записи
    grist.onRecord(function(record) {
      // Обновляем информацию о пациенте
      document.getElementById('fio').textContent = record.fio || '';
      document.getElementById('vozrast').textContent = record.vozrast || '';
      document.getElementById('diagnoz').textContent = record.diagnoz || '';
      document.getElementById('data_zasedaniya').textContent = record.data_zasedaniya || '';
      document.getElementById('reabilitacionnyi_diagnoz').textContent = record.reabilitacionnyi_diagnoz || '';
      document.getElementById('vrach_frm').textContent = record.vrach_frm || '';

      // Фильтруем записи по выбранному fio
      filterRecordsByFio(record.fio);
    });

    // Функция для фильтрации записей по fio
    async function filterRecordsByFio(fio) {
      // Получаем все записи из таблицы
      const allRecords = await grist.getAllRecords();

      // Фильтруем записи по выбранному fio
      const filteredRecords = allRecords.filter(record => record.fio === fio);

      // Очищаем таблицу перед добавлением новых данных
      const tableBody = document.querySelector('#doctorsTable tbody');
      tableBody.innerHTML = '';

      // Добавляем отфильтрованные записи в таблицу
      filteredRecords.forEach(function(record) {
        const row = tableBody.insertRow();
        row.insertCell().textContent = record.fio_sotr || ''; // Состав МКБ
        row.insertCell().textContent = record.uchastie_v_mkb || ''; // Участие в МКБ
        row.insertCell().textContent = record.cel || ''; // Цель
        row.insertCell().textContent = record.domen_i_ocenka_po_mkf || ''; // Домен и оценка по МКФ
        row.insertCell().textContent = record.zadachi || ''; // Задачи
        row.insertCell().textContent = record.metodika || ''; // Методика
        row.insertCell().textContent = record.fio_sotr || ''; // Исполнитель (ФИО)
        row.insertCell().textContent = record.ocenka_po_mkf_do_kursa || ''; // Оценка по МКФ до курса
        row.insertCell().textContent = record.ocenka_po_mkf_posle_kursa || ''; // Оценка по МКФ после курса
      });
    }
    </script>
</body>
</html>
