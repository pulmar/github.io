<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Протокол работы мультидисциплинарной бригады</title>
    
    <!-- Подключение необходимых библиотек -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.3/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid black; padding: 5px; text-align: left; }
        h1 { text-align: center; }
    </style>
</head>
<body>
    <h1>Протокол работы мультидисциплинарной бригады отделения реабилитации для детей РДКБ</h1>
    
    <p><strong>Пациент ФИО:</strong> <span id="patient_FIO"></span></p>
    <p><strong>Возраст:</strong> <span id="patient_age"></span></p>
    <p><strong>Диагноз:</strong> <span id="diagnoz"></span></p>
    <p><strong>Дата заседания:</strong> <span id="date_mdb"></span></p>
    <p><strong>Реабилитационный диагноз:</strong> <span id="reabilitacionnyi_diagnoz"></span></p>

    <table id="doctorsTable">
        <thead>
            <tr>
                <th>Состав МКБ</th>
                <th>Участие в МКБ</th>
                <th>Цель</th>
                <th>Домен и оценка по МКФ</th>
                <th>Задачи</th>
                <th>Методика</th>
                <th>Исполнитель (ФИО)</th>
                <th>Оценка по МКФ до курса</th>
                <th>Оценка по МКФ после курса</th>
            </tr>
        </thead>
        <tbody>
            <!-- Строки будут добавлены сюда -->
        </tbody>
    </table>

    <p><strong>Врач ФРМ (ФИО):</strong> <span id="FIO_user"></span> <span style="float: right;">Подпись _______________</span></p>

    <script>
    // Указываем, какие колонки нужны для работы виджета
    grist.ready({
      requiredAccess: 'read table',
      columns: [
        'patient_FIO', 'patient_age', 'diagnoz', 'date_mdb', 'reabilitacionnyi_diagnoz', 'FIO_user',
        'FIO_user', 'uchastie', 'target', 'Domen_C', 'zadachi', 'metodika',
        'ocenka_do_kursa', 'ocenka_posle'
      ]
    });

    // Обработка выбранной записи
    grist.onRecord(function(record) {
      console.log("Выбранная запись:", record); // Отладка

      // Обновляем информацию о пациенте
      document.getElementById('patient_FIO').textContent = record.patient_FIO || '';
      document.getElementById('patient_age').textContent = record.patient_age || '';
      document.getElementById('diagnoz').textContent = record.diagnoz || '';
      document.getElementById('date_mdb').textContent = record.date_mdb || '';
      document.getElementById('reabilitacionnyi_diagnoz').textContent = record.reabilitacionnyi_diagnoz || '';
      document.getElementById('FIO_user').textContent = record.FIO_user || '';

      // Фильтруем записи по выбранному patient_FIO
      filterRecordsByFio(record.patient_FIO);
    });

    // Функция для фильтрации записей по patient_FIO
    async function filterRecordsByFio(patient_FIO) {
      try {
        // Получаем все записи из таблицы
        const tableData = await grist.fetchSelectedTable();
        console.log("Данные таблицы:", tableData); // Отладка

        // Преобразуем данные в массив объектов
        const allRecords = transformTableDataToRecords(tableData);
        console.log("Все записи:", allRecords); // Отладка

        // Фильтруем записи по выбранному patient_FIO
        const filteredRecords = allRecords.filter(record => {
          console.log("Сравниваем:", record.patient_FIO, "с", patient_FIO); // Отладка
          return record.patient_FIO === patient_FIO;
        });
        console.log("Отфильтрованные записи:", filteredRecords); // Отладка

        // Очищаем таблицу перед добавлением новых данных
        const tableBody = document.querySelector('#doctorsTable tbody');
        tableBody.innerHTML = '';

        // Добавляем отфильтрованные записи в таблицу
        filteredRecords.forEach(function(record) {
          const row = tableBody.insertRow();
          row.insertCell().textContent = record.FIO_user || ''; // Состав МКБ
          row.insertCell().textContent = record.uchastie || ''; // Участие в МКБ
          row.insertCell().textContent = record.target || ''; // Цель
          row.insertCell().textContent = record.Domen_C || ''; // Домен и оценка по МКФ
          row.insertCell().textContent = record.zadachi || ''; // Задачи
          row.insertCell().textContent = record.metodika || ''; // Методика
          row.insertCell().textContent = record.FIO_user || ''; // Исполнитель (ФИО)
          row.insertCell().textContent = record.ocenka_do_kursa || ''; // Оценка по МКФ до курса
          row.insertCell().textContent = record.ocenka_posle || ''; // Оценка по МКФ после курса
        });
      } catch (error) {
        console.error("Ошибка при фильтрации записей:", error); // Отладка
      }
    }

    // Функция для преобразования данных таблицы в массив объектов
    function transformTableDataToRecords(tableData) {
      const records = [];
      const columns = Object.keys(tableData);
      const rowCount = tableData[columns[0]].length;

      for (let i = 0; i < rowCount; i++) {
        const record = {};
        columns.forEach(column => {
          record[column] = tableData[column][i];
        });
        records.push(record);
      }

      return records;
    }
    </script>
</body>
</html>
